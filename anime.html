<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Anime Info</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header dinamico -->
  <div id="header"></div>

  <!-- Contenuto Anime -->
  <div class="container">
    <div class="anime-card" id="card-content">
      <p>Caricamento anime...</p>
    </div>
  </div>

  <!-- Footer dinamico -->
  <div id="footer"></div>

  <script>
    // Mappa etichette leggibili
    const columnLabels = {
      "anime_id": "Anime ID", "title": "Title", "type": "Type", "score": "Score",
      "scored_by": "Number of Ratings", "status": "Status", "episodes": "Episodes",
      "start_date": "Start Date", "end_date": "End Date", "source": "Source Material",
      "members": "Member Count", "favorites": "Favorites Count", "episode_duration": "Episode Duration",
      "total_duration": "Total Duration", "rating": "Content Rating", "sfw": "Safe for Work",
      "approved": "Approved", "created_at": "Created At", "updated_at": "Updated At",
      "start_year": "Start Year", "start_season": "Start Season", "real_start_date": "Real Start Date",
      "real_end_date": "Real End Date", "broadcast_day": "Broadcast Day", "broadcast_time": "Broadcast Time",
      "genres": "Genres", "themes": "Themes", "demographics": "Demographics",
      "studios": "Studios", "producers": "Producers", "licensors": "Licensors",
      "synopsis": "Synopsis", "background": "Background Information",
      "main_picture": "Main Image", "url": "Official URL", "trailer_url": "Trailer URL",
      "title_english": "English Title", "title_japanese": "Japanese Title",
      "title_synonyms": "Alternative Titles", "anime_url": "Official URL"
    };

    // Sezioni organizzate
    const sections = {
      "Titles": ["title_english", "title_japanese", "title_synonyms"],
      "Classification": ["type", "score", "scored_by", "status", "rating", "sfw"],
      "Episodes": ["episodes", "episode_duration", "total_duration"],
      "Dates": ["start_date", "end_date", "real_start_date", "real_end_date", "start_year", "start_season", "broadcast_day", "broadcast_time"],
      "Production": ["source", "studios", "producers", "licensors"],
      "Popularity": ["members", "favorites", "approved", "genres", "themes", "demographics"],
      "Meta": ["created_at", "updated_at"]
    };

    function parseCSV(csvText) {
      const lines = csvText.split("\n").filter(l => l.trim() !== "");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }

    function renderField(label, value) {
      if (!value || value.trim() === "") return "";
      return `<p><strong>${label}:</strong> ${value}</p>`;
    }

    function renderSection(title, fields, anime) {
      const content = fields.map(f => renderField(columnLabels[f], anime[f])).join("");
      return content ? `<section><h2>${title}</h2>${content}</section>` : "";
    }

    function embedYouTube(url) {
      if (!url || (!url.includes("youtube.com") && !url.includes("youtu.be"))) return "";
      const idMatch = url.match(/(?:youtube\.com\/.*v=|youtu\.be\/)([\w-]+)/);
      if (!idMatch || !idMatch[1]) return "";
      const videoId = idMatch[1];
      return `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
    }

    async function loadAnime() {
      const params = new URLSearchParams(window.location.search);
      const animeId = params.get("id");

      if (!animeId) {
        document.getElementById("card-content").innerHTML = "<p>ID non trovato.</p>";
        return;
      }

      const res = await fetch("data/anime.csv");
      const csv = await res.text();
      const animeList = parseCSV(csv);
      const anime = animeList.find(a => a.anime_id === animeId);

      if (!anime) {
        document.getElementById("card-content").innerHTML = "<p>Anime non trovato.</p>";
        return;
      }

      document.title = anime.title;

      let html = `
        <div class="anime-header">
          ${anime.main_picture ? `<img src="${anime.main_picture}" alt="${anime.title}">` : ""}
          <div class="anime-info">
            <h1>${anime.title}</h1>
            ${renderField("English Title", anime.title_english)}
            ${renderField("Japanese Title", anime.title_japanese)}
          </div>
        </div>
      `;

      for (const [title, fields] of Object.entries(sections)) {
        html += renderSection(title, fields, anime);
      }

      if (anime.synopsis || anime.background) {
        html += `<section><h2>Trama</h2>`;
        if (anime.synopsis) html += `<p><strong>Synopsis:</strong> ${anime.synopsis}</p>`;
        if (anime.background) html += `<p><strong>Background:</strong> ${anime.background}</p>`;
        html += `</section>`;
      }

      if (anime.trailer_url) {
        html += `<section><h2>Trailer</h2>${embedYouTube(anime.trailer_url)}</section>`;
      }

      if (anime.url) {
        html += `<p><a href="${anime.url}" target="_blank">üåê Scheda ufficiale</a></p>`;
      }

      html += `<a href="index.html" class="back-link">‚¨Ö Torna all‚Äôelenco</a>`;

      document.getElementById("card-content").innerHTML = html;
    }

    async function loadLayout() {
      const header = await fetch("header.html").then(r => r.text());
      const footer = await fetch("footer.html").then(r => r.text());
      document.getElementById("header").innerHTML = header;
      document.getElementById("footer").innerHTML = footer;
    }

    loadLayout();
    loadAnime();
  </script>
</body>
</html>
