<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Anime Info</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 0;
    }
    #anime-container {
      max-width: 900px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    section {
      margin-bottom: 2rem;
    }
    section h2 {
      border-bottom: 2px solid #eee;
      padding-bottom: 0.3rem;
      font-size: 1.3rem;
      color: #2c3e50;
    }
    p {
      margin: 0.5rem 0;
    }
    .anime-image {
      float: right;
      margin-left: 20px;
      max-width: 250px;
      border-radius: 6px;
    }
    a {
      color: #3498db;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .back-link {
      margin-top: 2rem;
      display: block;
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <main id="anime-container">
    <p>Caricamento dati anime...</p>
  </main>

  <div id="footer"></div>

  <script>
    // Etichette leggibili
    const columnLabels = {
      "anime_id": "Anime ID", "title": "Title", "type": "Type", "score": "Score",
      "scored_by": "Number of Ratings", "status": "Status", "episodes": "Episodes",
      "start_date": "Start Date", "end_date": "End Date", "source": "Source Material",
      "members": "Member Count", "favorites": "Favorites Count", "episode_duration": "Episode Duration",
      "total_duration": "Total Duration", "rating": "Content Rating", "sfw": "Safe for Work",
      "approved": "Approved", "created_at": "Created At", "updated_at": "Updated At",
      "start_year": "Start Year", "start_season": "Start Season", "real_start_date": "Real Start Date",
      "real_end_date": "Real End Date", "broadcast_day": "Broadcast Day", "broadcast_time": "Broadcast Time",
      "genres": "Genres", "themes": "Themes", "demographics": "Demographics",
      "studios": "Studios", "producers": "Producers", "licensors": "Licensors",
      "synopsis": "Synopsis", "background": "Background Information",
      "main_picture": "Main Image", "url": "Official URL", "trailer_url": "Trailer URL",
      "title_english": "English Title", "title_japanese": "Japanese Title",
      "title_synonyms": "Alternative Titles", "anime_url": "Official URL"
    };

    // Sezioni raggruppate logicamente
    const sections = {
      "Identity and Titles": ["title", "title_english", "title_japanese", "title_synonyms"],
      "Classification and Ratings": ["type", "score", "scored_by", "status", "rating", "sfw"],
      "Episodes and Duration": ["episodes", "episode_duration", "total_duration"],
      "Dates and Broadcast Period": ["start_date", "end_date", "real_start_date", "real_end_date",
                                    "start_year", "start_season", "broadcast_day", "broadcast_time"],
      "Origin and Production": ["source", "studios", "producers", "licensors"],
      "Popularity and Insight": ["members", "favorites", "approved", "genres", "themes", "demographics"],
      "Content and Media": ["synopsis", "background", "trailer_url"],
      "Technical Metadata": ["created_at", "updated_at"]
    };

    // Carica HTML statici
    async function loadHTML(id, url) {
      const res = await fetch(url);
      const html = await res.text();
      document.getElementById(id).innerHTML = html;
    }

    loadHTML("header", "header.html");
    loadHTML("footer", "footer.html");

    function parseCSV(csvText) {
      const lines = csvText.split("\n").filter(l => l.trim() !== "");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }

    function renderField(label, value) {
      if (!value || value.trim() === "") return "";
      return `<p><strong>${label}:</strong> ${value}</p>`;
    }

    function renderSection(title, fields, anime) {
      const content = fields.map(f => renderField(columnLabels[f], anime[f])).join("");
      return content ? `<section><h2>${title}</h2>${content}</section>` : "";
    }

    async function loadAnime() {
      const params = new URLSearchParams(window.location.search);
      const animeId = params.get("id");

      if (!animeId) {
        document.getElementById("anime-container").innerHTML = "<p>ID non trovato nell'URL.</p>";
        return;
      }

      const res = await fetch("data/anime.csv");
      const csv = await res.text();
      const animeList = parseCSV(csv);

      const anime = animeList.find(a => a.anime_id === animeId);

      if (!anime) {
        document.getElementById("anime-container").innerHTML = "<p>Anime non trovato.</p>";
        return;
      }

      document.title = anime.title;

      let html = `<h1>${anime.title}</h1>`;

      if (anime.main_picture) {
        html += `<img class="anime-image" src="${anime.main_picture}" alt="${anime.title}">`;
      }

      for (const [sectionTitle, fields] of Object.entries(sections)) {
        html += renderSection(sectionTitle, fields, anime);
      }

      if (anime.url) {
        html += `<p><a href="${anime.url}" target="_blank">Scheda ufficiale</a></p>`;
      }
      if (anime.trailer_url) {
        html += `<p><a href="${anime.trailer_url}" target="_blank">Guarda il trailer</a></p>`;
      }

      html += `<a class="back-link" href="index.html">â¬… Torna all'elenco</a>`;

      document.getElementById("anime-container").innerHTML = html;
    }

    loadAnime();
  </script>
</body>
</html>
