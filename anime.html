<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Anime Detail</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Nunito Sans', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    .anime-container {
      max-width: 900px;
      margin: 80px auto;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      padding: 30px;
    }
    .anime-header {
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
        padding: 12px 20px;
        z-index: 1000;
        width: 100%;
        position: relative; /* Imposta relative, rimuovendo sticky o fixed */
    }
    .anime-image {
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
      object-fit: cover;
    }
    .anime-details {
      flex: 1;
      min-width: 280px;
    }
    h1 {
      margin: 0 0 10px 0;
    }
    h3 {
      margin-top: 40px;
      color: #444;
    }
    .anime-meta {
      margin-bottom: 10px;
      font-size: 0.95em;
      color: #666;
    }
    .anime-section {
      margin-top: 20px;
      line-height: 1.6;
      position: relative;
    }
    .anime-description {
      margin-top: 20px;
      line-height: 1.6;
      position: relative;
    }
    iframe {
      width: 100%;
      height: 315px;
      border: none;
      border-radius: 8px;
    }
    .description-short {
      overflow: hidden;
      max-height: 200px;
    }
    .read-more-btn {
      display: inline-block;
      margin-top: 10px;
      color: #007bff;
      cursor: pointer;
      font-size: 0.95em;
    }
    .error {
      text-align: center;
      margin-top: 100px;
      font-size: 1.5em;
      color: red;
    }
  </style>
</head>
<body>

  <div id="header"></div>

  <div id="content" class="anime-container">
    <div id="loading">Loading...</div>
  </div>

  <div id="footer"></div>

  <script>
    // === Etichette leggibili ===
    const columnLabels = {
      anime_id: "Anime ID", title: "Title", type: "Type", score: "Score",
      scored_by: "Number of Ratings", status: "Status", episodes: "Episodes",
      start_date: "Start Date", end_date: "End Date", source: "Source Material",
      members: "Member Count", favorites: "Favorites Count", episode_duration: "Episode Duration",
      total_duration: "Total Duration", rating: "Content Rating", sfw: "Safe for Work",
      approved: "Approved", created_at: "Created At", updated_at: "Updated At",
      start_year: "Start Year", start_season: "Start Season", real_start_date: "Real Start Date",
      real_end_date: "Real End Date", broadcast_day: "Broadcast Day", broadcast_time: "Broadcast Time",
      genres: "Genres", themes: "Themes", demographics: "Demographics",
      studios: "Studios", producers: "Producers", licensors: "Licensors",
      synopsis: "Synopsis", background: "Background Information",
      main_picture: "Main Image", url: "Official URL", trailer_url: "Trailer URL",
      title_english: "English Title", title_japanese: "Japanese Title",
      title_synonyms: "Alternative Titles", anime_url: "Official URL"
    };

    // === Sezioni organizzate ===
    const sections = {
      "Identity and Titles": ["title", "title_english", "title_japanese", "title_synonyms"],
      "Classification and Ratings": ["type", "score", "scored_by", "status", "rating", "sfw"],
      "Episodes and Duration": ["episodes", "episode_duration", "total_duration"],
      "Dates and Broadcast Period": ["start_date", "end_date", "real_start_date", "real_end_date", "start_year", "start_season", "broadcast_day", "broadcast_time"],
      "Origin and Production": ["source", "studios", "producers", "licensors"],
      "Popularity and Insight": ["members", "favorites", "approved", "genres", "themes", "demographics"],
      "Content and Media": ["synopsis", "background", "trailer_url"],
      "Technical Metadata": ["created_at", "updated_at"]
    };

    // Carica header e footer
    fetch("header.html").then(res => res.text()).then(data => {
      document.getElementById("header").innerHTML = data;
    });
    fetch("footer.html").then(res => res.text()).then(data => {
      document.getElementById("footer").innerHTML = data;
    });

    // Estrai ID da URL
    const params = new URLSearchParams(window.location.search);
    const animeId = params.get("id");

    // Usa PapaParse per leggere CSV
    function parseCSVWithPapa(text) {
      return Papa.parse(text, {
        header: true,
        skipEmptyLines: true
      }).data;
    }

    // Format multiline text
    function formatMultiline(text) {
      if (!text) return "‚Äî";
      return text
        .replace(/\r\n|\r|\n/g, "<br>")
        .replace(/""/g, '"')
        .replace(/^"|"$/g, "");
    }

    // Parsare array
    function parseArray(str) {
      try {
        const arr = JSON.parse(str);
        return Array.isArray(arr) ? arr.join(", ") : str;
      } catch {
        return str;
      }
    }

    // Genera dettaglio anime
    function generateAnimeDetails(anime) {
      const synopsisFormatted = formatMultiline(anime.synopsis).replace(/\[Written by MAL Rewrite\]$/g, '');
      const synopsisId = "synopsis-" + anime.anime_id;

      let html = `
        <div class="anime-header">
          <img class="anime-image" src="${anime.main_picture}" alt="${anime.title}">
          <div class="anime-details">
            <h1>${anime.title_english || anime.title}</h1>
            <div class="anime-meta">üóì ${anime.start_date} ‚Äî ${anime.end_date || "In corso"}</div>
            <div class="anime-meta">üé¨ Type: ${anime.type} ‚Äî üé• Episodes: ${anime.episodes || "?"}</div>
            <div class="anime-meta">‚≠ê Score: ${anime.score} (${anime.scored_by} voti)</div>
            <div class="anime-meta">üì∫ Studio: ${anime.studios}</div>
            <div class="anime-meta">üé≠ Genres: ${parseArray(anime.genres)}</div>
          </div>
        </div>
        <div class="anime-section">
          <h3>Trailer</h3>
          <iframe src="${anime.trailer_url.replace('watch?v=', 'embed/')}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <div class="anime-description">
          <h2>Description</h2>
          <p>${synopsisFormatted}</p>
        </div>
      `;

      // Aggiungi le altre sezioni come prima
      for (const [sectionName, fields] of Object.entries(sections)) {
        let sectionHtml = "";
        for (const field of fields) {
          let value = anime[field];
          if (!value || value === "[]") continue;

          if (value.startsWith("[") && value.endsWith("]")) {
            try {
              value = JSON.parse(value).join(", ");
            } catch {}
          }

          if (["synopsis", "background", "main_picture"].includes(field)) continue;

          sectionHtml += `<p><strong>${columnLabels[field] || field}:</strong> ${value}</p>`;
        }

        if (sectionHtml)
          html += `<div class="anime-section"><h3>${sectionName}</h3>${sectionHtml}</div>`;
      }

      return html;
    }

    // Toggle descrizione
    function toggleSynopsis(id, btn) {
      const el = document.getElementById(id);
      if (el.classList.contains("description-short")) {
        el.classList.remove("description-short");
        btn.innerText = "Leggi meno";
      } else {
        el.classList.add("description-short");
        btn.innerText = "Leggi di pi√π";
      }
    }

    // Carica CSV e mostra i dati
    fetch("data/anime.csv")
      .then(response => response.text())
      .then(csvText => {
        const data = parseCSVWithPapa(csvText);
        const anime = data.find(a => a.anime_id === animeId);
        if (!anime) {
          document.getElementById("content").innerHTML = `<div class="error">Anime Not Found<br>ID Found: ${animeId}</div>`;
          return;
        }
        document.getElementById("content").innerHTML = generateAnimeDetails(anime);
      })
      .catch(error => {
        document.getElementById("content").innerHTML = `<div class="error">Error Loading: ${error}</div>`;
      });
  </script>

</body>
</html>
