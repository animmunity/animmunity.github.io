<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Anime Info</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root {
      --fire: #FF9C54;
      --water: #4D90D5;
      --grass: #63bb5b;
      --electric: #F3D23B;
      --psychic: #F97176;
      --ice: #74CEC0;
      --dark: #5A5366;
      --fairy: #EC8FE6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Nunito Sans', sans-serif;
      font-size: 16px;
      font-weight: 400;
      line-height: 1.6;
      color: #000;
      background-color: #fff;
      margin: 0;
      height: 100dvh;
      overflow: auto;
    }

    #anime-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }

    .anime-header {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .anime-header img {
      max-width: 240px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .anime-title h1 {
      margin: 0;
      font-size: 2rem;
    }

    section {
      background: #f5f5f5;
      padding: 1rem 1.5rem;
      border-radius: 8px;
    }

    section h2 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.25rem;
      border-left: 4px solid var(--water);
      padding-left: 0.5rem;
    }

    section p {
      margin: 0.5rem 0;
    }

    a {
      color: var(--fire);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .back-link {
      display: inline-block;
      margin-top: 2rem;
      color: var(--dark);
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <main id="anime-container">
    <p>Caricamento dati anime...</p>
  </main>

  <div id="footer"></div>

  <script>
    const columnLabels = {
      "anime_id": "Anime ID", "title": "Title", "type": "Type", "score": "Score",
      "scored_by": "Number of Ratings", "status": "Status", "episodes": "Episodes",
      "start_date": "Start Date", "end_date": "End Date", "source": "Source Material",
      "members": "Member Count", "favorites": "Favorites Count", "episode_duration": "Episode Duration",
      "total_duration": "Total Duration", "rating": "Content Rating", "sfw": "Safe for Work",
      "approved": "Approved", "created_at": "Created At", "updated_at": "Updated At",
      "start_year": "Start Year", "start_season": "Start Season", "real_start_date": "Real Start Date",
      "real_end_date": "Real End Date", "broadcast_day": "Broadcast Day", "broadcast_time": "Broadcast Time",
      "genres": "Genres", "themes": "Themes", "demographics": "Demographics",
      "studios": "Studios", "producers": "Producers", "licensors": "Licensors",
      "synopsis": "Synopsis", "background": "Background Information",
      "main_picture": "Main Image", "url": "Official URL", "trailer_url": "Trailer URL",
      "title_english": "English Title", "title_japanese": "Japanese Title",
      "title_synonyms": "Alternative Titles", "anime_url": "Official URL"
    };

    const sections = {
      "Identity and Titles": ["title_english", "title_japanese", "title_synonyms"],
      "Classification and Ratings": ["type", "score", "scored_by", "status", "rating", "sfw"],
      "Episodes and Duration": ["episodes", "episode_duration", "total_duration"],
      "Dates and Broadcast Period": ["start_date", "end_date", "real_start_date", "real_end_date", "start_year", "start_season", "broadcast_day", "broadcast_time"],
      "Origin and Production": ["source", "studios", "producers", "licensors"],
      "Popularity and Insight": ["members", "favorites", "approved", "genres", "themes", "demographics"],
      "Content and Media": ["synopsis", "background", "trailer_url"],
      "Technical Metadata": ["created_at", "updated_at"]
    };

    async function loadHTML(id, url) {
      const res = await fetch(url);
      const html = await res.text();
      document.getElementById(id).innerHTML = html;
    }

    loadHTML("header", "header.html");
    loadHTML("footer", "footer.html");

    function parseCSV(csvText) {
      const lines = csvText.split("\n").filter(l => l.trim() !== "");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }

    function renderField(label, value) {
      if (!value || value.trim() === "") return "";
      return `<p><strong>${label}:</strong> ${value}</p>`;
    }

    function renderSection(title, fields, anime) {
      const content = fields.map(f => renderField(columnLabels[f], anime[f])).join("");
      return content ? `<section><h2>${title}</h2>${content}</section>` : "";
    }

    async function loadAnime() {
      const params = new URLSearchParams(window.location.search);
      const animeId = params.get("id");

      if (!animeId) {
        document.getElementById("anime-container").innerHTML = "<p>ID non trovato nell'URL.</p>";
        return;
      }

      const res = await fetch("data/anime.csv");
      const csv = await res.text();
      const animeList = parseCSV(csv);
      const anime = animeList.find(a => a.anime_id === animeId);

      if (!anime) {
        document.getElementById("anime-container").innerHTML = "<p>Anime non trovato.</p>";
        return;
      }

      document.title = anime.title;

      let html = `
        <div class="anime-header">
          ${anime.main_picture ? `<img src="${anime.main_picture}" alt="${anime.title}">` : ""}
          <div class="anime-title">
            <h1>${anime.title}</h1>
          </div>
        </div>
      `;

      for (const [sectionTitle, fields] of Object.entries(sections)) {
        html += renderSection(sectionTitle, fields, anime);
      }

      if (anime.url) {
        html += `<p><a href="${anime.url}" target="_blank">Scheda ufficiale</a></p>`;
      }
      if (anime.trailer_url) {
        html += `<p><a href="${anime.trailer_url}" target="_blank">Guarda il trailer</a></p>`;
      }

      html += `<a class="back-link" href="index.html">â¬… Torna all'elenco</a>`;
      document.getElementById("anime-container").innerHTML = html;
    }

    loadAnime();
  </script>
</body>
</html>
