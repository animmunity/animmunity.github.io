<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>AniMMunity - Anime Info</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: 'Nunito Sans', sans-serif;
      margin: 0;
      background-color: #f9f9f9;
      color: #222;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 2rem;
    }
    .section {
      margin-bottom: 2rem;
    }
    .section h2 {
      font-size: 1.2rem;
      color: #4D90D5;
      border-bottom: 2px solid #4D90D5;
      padding-bottom: 0.3rem;
      margin-bottom: 0.8rem;
    }
    .row {
      margin-bottom: 0.5rem;
    }
    .row span.label {
      font-weight: bold;
      color: #333;
    }
    .image-trailer {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    .image-trailer img {
      width: 300px;
      border-radius: 8px;
    }
    iframe {
      width: 480px;
      height: 270px;
      border: none;
      border-radius: 8px;
    }
    .not-found {
      text-align: center;
      padding: 4rem;
      color: #666;
    }
  </style>
</head>
<body>

<div id="header-container"></div>

<main class="container" id="anime-content">
  <!-- Contenuto dinamico -->
</main>

<div id="footer-container"></div>

<script>
  // === Carica header/footer ===
  fetch("header.html").then(res => res.text()).then(data => {
    document.getElementById("header-container").innerHTML = data;
  });
  fetch("footer.html").then(res => res.text()).then(data => {
    document.getElementById("footer-container").innerHTML = data;
  });

  // === Estrai ID dalla URL ===
  const urlParams = new URLSearchParams(window.location.search);
  const animeID = urlParams.get('id');

  // === Etichette leggibili ===
  const columnLabels = {
    "anime_id": "Anime ID", "title": "Title", "type": "Type", "score": "Score",
    "scored_by": "Number of Ratings", "status": "Status", "episodes": "Episodes",
    "start_date": "Start Date", "end_date": "End Date", "source": "Source Material",
    "members": "Member Count", "favorites": "Favorites Count", "episode_duration": "Episode Duration",
    "total_duration": "Total Duration", "rating": "Content Rating", "sfw": "Safe for Work",
    "approved": "Approved", "created_at": "Created At", "updated_at": "Updated At",
    "start_year": "Start Year", "start_season": "Start Season", "real_start_date": "Real Start Date",
    "real_end_date": "Real End Date", "broadcast_day": "Broadcast Day", "broadcast_time": "Broadcast Time",
    "genres": "Genres", "themes": "Themes", "demographics": "Demographics",
    "studios": "Studios", "producers": "Producers", "licensors": "Licensors",
    "synopsis": "Synopsis", "background": "Background Information",
    "main_picture": "Main Image", "url": "Official URL", "trailer_url": "Trailer URL",
    "title_english": "English Title", "title_japanese": "Japanese Title",
    "title_synonyms": "Alternative Titles", "anime_url": "Official URL"
  };

  const sections = {
    "Identity and Titles": ["title", "title_english", "title_japanese", "title_synonyms"],
    "Classification and Ratings": ["type", "score", "scored_by", "status", "rating", "sfw"],
    "Episodes and Duration": ["episodes", "episode_duration", "total_duration"],
    "Dates and Broadcast Period": ["start_date", "end_date", "real_start_date", "real_end_date",
                                   "start_year", "start_season", "broadcast_day", "broadcast_time"],
    "Origin and Production": ["source", "studios", "producers", "licensors"],
    "Popularity and Insight": ["members", "favorites", "approved", "genres", "themes", "demographics"],
    "Content and Media": ["synopsis", "background", "trailer_url"],
    "Technical Metadata": ["created_at", "updated_at"]
  };

  // === CSV â†’ JSON ===
  function parseCSV(text) {
    const lines = text.split('\n').filter(Boolean);
    const headers = lines[0].split(',');

    return lines.slice(1).map(line => {
      const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = values[i]?.replace(/^"|"$/g, '').trim());
      return obj;
    });
  }

  // === Genera pagina dettaglio ===
  function renderDetail(anime) {
    const container = document.getElementById("anime-content");
    container.innerHTML = '';

    // Immagine + trailer
    const mediaDiv = document.createElement('div');
    mediaDiv.className = "image-trailer";

    if (anime.main_picture)
      mediaDiv.innerHTML += `<img src="${anime.main_picture}" alt="${anime.title}">`;

    if (anime.trailer_url && anime.trailer_url.includes("youtube.com")) {
      const embedURL = anime.trailer_url.replace("watch?v=", "embed/");
      mediaDiv.innerHTML += `<iframe src="${embedURL}" allowfullscreen></iframe>`;
    }

    container.appendChild(mediaDiv);

    // Sezioni
    for (const [sectionTitle, fields] of Object.entries(sections)) {
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'section';
      sectionDiv.innerHTML = `<h2>${sectionTitle}</h2>`;

      fields.forEach(field => {
        const value = anime[field];
        if (value && value !== '[]') {
          sectionDiv.innerHTML += `
            <div class="row">
              <span class="label">${columnLabels[field] || field}:</span>
              <span class="value"> ${value.replaceAll("['", "").replaceAll("']", "").replaceAll("', '", ', ')}</span>
            </div>
          `;
        }
      });

      container.appendChild(sectionDiv);
    }
  }

  // === Avvia ===
  fetch('data/anime.csv')
    .then(res => res.text())
    .then(csv => {
      const list = parseCSV(csv);

      if (animeID) {
        const anime = list.find(a => a.anime_id === animeID);
        if (anime) {
          renderDetail(anime);
        } else {
          document.getElementById("anime-content").innerHTML = `
            <div class="not-found"><h2>Anime non trovato</h2><p>ID: ${animeID}</p></div>
          `;
        }
      } else {
        document.getElementById("anime-content").innerHTML = `
          <div class="not-found"><h2>Usa ?id=XXXX per visualizzare un anime.</h2></div>
        `;
      }
    });
</script>
</body>
</html>
