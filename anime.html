<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Anime Detail</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: 'Nunito Sans', sans-serif; background:#f9f9f9; margin:0 }
    .anime-container { max-width: 900px; margin: 80px auto; background:#fff; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,.1); padding:30px }
    .anime-header { display:flex; gap:30px; flex-wrap:wrap; align-items:flex-start }
    .anime-image { width:100%; max-width:300px; border-radius:8px; object-fit:cover }
    .anime-details { flex:1; min-width:280px }
    h1 { margin:0 0 10px 0 }
    h3 { margin-top:40px; color:#444 }
    .anime-meta { margin-bottom:10px; font-size:.95em; color:#666 }
    .anime-section, .anime-description { margin-top:20px; line-height:1.6; position:relative }
    iframe { width:100%; height:315px; border:none; border-radius:8px }
    .description-short { overflow:hidden; max-height:200px }
    .read-more-btn { display:inline-block; margin-top:10px; color:#007bff; cursor:pointer; font-size:.95em }
    .error { text-align:center; margin:100px 0; font-size:1.1rem; color:red }
    #loading { text-align:center; padding:40px 0; color:#666 }
  </style>
</head>
<body>
  <div id="header"></div>
  <div id="content" class="anime-container">
    <div id="loading">Loading...</div>
  </div>
  <div id="footer"></div>

  <script>
    // === Etichette leggibili ===
    const columnLabels = {
      anime_id: "Anime ID", title: "Title", type: "Type", score: "Score",
      scored_by: "Number of Ratings", status: "Status", episodes: "Episodes",
      start_date: "Start Date", end_date: "End Date", source: "Source Material",
      members: "Member Count", favorites: "Favorites Count", episode_duration: "Episode Duration",
      total_duration: "Total Duration", rating: "Content Rating", sfw: "Safe for Work",
      approved: "Approved", created_at: "Created At", updated_at: "Updated At",
      start_year: "Start Year", start_season: "Start Season", real_start_date: "Real Start Date",
      real_end_date: "Real End Date", broadcast_day: "Broadcast Day", broadcast_time: "Broadcast Time",
      genres: "Genres", themes: "Themes", demographics: "Demographics",
      studios: "Studios", producers: "Producers", licensors: "Licensors",
      synopsis: "Synopsis", background: "Background Information",
      main_picture: "Main Image", url: "Official URL", trailer_url: "Trailer URL",
      title_english: "English Title", title_japanese: "Japanese Title",
      title_synonyms: "Alternative Titles", anime_url: "Official URL"
    };

    // === Sezioni organizzate ===
    const sections = {
      "Identity and Titles": ["title", "title_english", "title_japanese", "title_synonyms"],
      "Classification and Ratings": ["type", "score", "scored_by", "status", "rating", "sfw"],
      "Episodes and Duration": ["episodes", "episode_duration", "total_duration"],
      "Dates and Broadcast Period": ["start_date", "end_date", "real_start_date", "real_end_date", "start_year", "start_season", "broadcast_day", "broadcast_time"],
      "Origin and Production": ["source", "studios", "producers", "licensors"],
      "Popularity and Insight": ["members", "favorites", "approved", "genres", "themes", "demographics"],
      "Content and Media": ["synopsis", "background", "trailer_url"],
      "Technical Metadata": ["created_at", "updated_at"]
    };

    // Carica header e footer
    fetch("header.html").then(r => r.text()).then(t => { document.getElementById("header").innerHTML = t; }).catch(()=>{});
    fetch("footer.html").then(r => r.text()).then(t => { document.getElementById("footer").innerHTML = t; }).catch(()=>{});

    // Estrai ID da URL
    const params = new URLSearchParams(window.location.search);
    const animeId = (params.get("id") || "").trim();

    // Usa PapaParse per leggere CSV
    function parseCSVWithPapa(text) {
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      return parsed.data || [];
    }

    // Format multiline text
    function formatMultiline(text) {
      if (!text) return "‚Äî";
      return String(text)
        .replace(/\r\n|\r|\n/g, "<br>")
        .replace(/""/g, '"')
        .replace(/^"|"$/g, "");
    }

    // Parsare array se in JSON (e.g. "[\"Action\",\"Drama\"]")
    function parseArray(str) {
      if (!str) return "‚Äî";
      try {
        const arr = JSON.parse(str);
        return Array.isArray(arr) ? arr.join(", ") : String(str);
      } catch {
        return String(str);
      }
    }

    function safe(val) {
      return (val === null || val === undefined || val === "") ? "‚Äî" : String(val);
    }

    function toYouTubeEmbed(url) {
      if (!url) return null;
      try {
        if (url.includes("/watch?v=")) return url.replace("watch?v=", "embed/");
        if (url.includes("youtu.be/")) return url.replace("youtu.be/", "www.youtube.com/embed/");
        if (url.includes("/embed/")) return url; // gi√† embed
      } catch {}
      return null; // non-YouTube o non valido
    }

    // Genera dettaglio anime
    function generateAnimeDetails(anime) {
      const synopsisFormatted = formatMultiline(String(anime.synopsis || "").replace(/\[Written by MAL Rewrite\]$/g, ""));

      let html = `
        <div class="anime-header">
          <img class="anime-image" src="${safe(anime.main_picture)}" alt="${safe(anime.title)}" onerror="this.style.display='none'" />
          <div class="anime-details">
            <h1>${safe(anime.title_english) !== '‚Äî' ? safe(anime.title_english) : safe(anime.title)}</h1>
            <div class="anime-meta">üóì ${safe(anime.start_date)} ‚Äî ${anime.end_date ? safe(anime.end_date) : "In corso"}</div>
            <div class="anime-meta">üé¨ Type: ${safe(anime.type)} ‚Äî üé• Episodes: ${safe(anime.episodes)}</div>
            <div class="anime-meta">‚≠ê Score: ${safe(anime.score)} (${safe(anime.scored_by)} voti)</div>
            <div class="anime-meta">üì∫ Studio: ${safe(anime.studios)}</div>
            <div class="anime-meta">üé≠ Genres: ${parseArray(anime.genres)}</div>
          </div>
        </div>`;

      const embedUrl = toYouTubeEmbed(anime.trailer_url);
      if (embedUrl) {
        html += `
          <div class="anime-section">
            <h3>Trailer</h3>
            <iframe src="${embedUrl}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>`;
      }

      html += `
        <div class="anime-description">
          <h2>Description</h2>
          <p>${synopsisFormatted}</p>
        </div>`;

      // Altre sezioni
      for (const [sectionName, fields] of Object.entries(sections)) {
        let sectionHtmlParts = [];
        for (const field of fields) {
          if (["synopsis", "background", "main_picture", "trailer_url"].includes(field)) continue;
          let value = anime[field];
          if (value === null || value === undefined || value === "") continue;
          if (typeof value === 'string' && value.trim() === '[]') continue;

          // Array in JSON
          if (typeof value === 'string' && value.startsWith('[') && value.endsWith(']')) {
            try { value = JSON.parse(value).join(', '); } catch { /* keep as is */ }
          }
          sectionHtmlParts.push(`<p><strong>${columnLabels[field] || field}:</strong> ${safe(value)}</p>`);
        }
        if (sectionHtmlParts.length) {
          html += `<div class="anime-section"><h3>${sectionName}</h3>${sectionHtmlParts.join('')}</div>`;
        }
      }
      return html;
    }

    // Carica CSV e mostra i dati
    fetch("data/anime.csv")
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.text();
      })
      .then(csvText => {
        const data = parseCSVWithPapa(csvText).map(r => ({ ...r, anime_id: String(r.anime_id || '').trim() }));
        const anime = data.find(a => a.anime_id === animeId);
        const contentEl = document.getElementById("content");
        if (!anime) {
          contentEl.innerHTML = `<div class="error">Anime Not Found<br>ID: ${animeId || '‚Äî'}</div>`;
          return;
        }
        contentEl.innerHTML = generateAnimeDetails(anime);
      })
      .catch(error => {
        document.getElementById("content").innerHTML = `<div class="error">Error Loading: ${error?.message || error}</div>`;
      })
      .finally(() => {
        const loading = document.getElementById('loading');
        if (loading) loading.remove();
      });
  </script>
</body>
</html>
